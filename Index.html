<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Espana 2025</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

  <!-- Omnivore for GPX/KML/CSV reading -->
  <script src="https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.3.1/leaflet-omnivore.min.js"></script>

  <!-- Optional: leaflet-deflate if you want to keep your deflate behavior -->
  <link rel="stylesheet" href="dist/leaflet-list-markers.css" />
  <script src="dist/L.Deflate.js"></script>

  <!-- jQuery + PapaParse for CSV marker placeholders -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>

  <style>
    html,body,#map { height: 100%; margin: 0; padding: 0; }
    #title-pane {
      position: absolute;
      left: 0; right: 0; top: 12px;
      text-align: center;
      z-index: 800;
      font-family: "Pacifico", Arial;
      font-size: 30px;
      color: white;
      text-shadow: 2px 2px 10px rgba(0,0,0,0.8);
      pointer-events: none;
    }
    .popupImage { max-width: 200px; display:block; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="title-pane">Espana 2025</div>

  <script>
    // ------------------------------
    // Basic map + base layers
    // ------------------------------
    const baseLayers = {
      'Terrain': L.tileLayer('http://{s}.google.com/vt/lyrs=p&x={x}&y={y}&z={z}', { maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3'] }),
      'Imagery': L.tileLayer('http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 20 })
    };

    const map = L.map('map', {
      center: [40.0, -3.7], // centered roughly over Spain; a
